- [监控的基本概念](#监控的基本概念)
- [监控体系&指标](#监控体系指标)
  - [基础设施监控](#基础设施监控)
  - [系统信息监控](#系统信息监控)
  - [业务监控](#业务监控)
  - [用户体验监控](#用户体验监控)
- [监控部署](#监控部署)
  - [业务风险点的梳理](#业务风险点的梳理)
  - [业务系统埋点](#业务系统埋点)
  - [配置和预警校验](#配置和预警校验)
    - [告警项配置](#告警项配置)
      - [告警配置字段](#告警配置字段)
      - [告警配置策略](#告警配置策略)


# 监控的基本概念

监控项：监控项是承载业务或系统监控能力的最小单元；

如下图所示，一个监控项包含采集源、监控指标、报警项、通知项几个元素分别解决监控元数据怎么来、从哪些维度监控、怎么报警、通知给谁的问题；而作为监控的基础开始“监控对象”则解决监控谁的问题。
![avatar](/resource/监控项的组成.png)


监控产品的一般构建：一个完整的监控产品往往由埋点、采集、计算、存储、输出（报警、展示）等几部分构成，被应用于应急响应、故障定位、统计决策，作用于问题的发现、响应、定位等全过程。
![avatar](/resource/监控产品的构成.png)


# 监控体系&指标

## 基础设施监控

主要关注机房动环、网络等基础设施的运行情况.
![avatar](/resource/监控基础设施1.jpg)
![avatar](/resource/监控基础设施2.jpg)
![avatar](/resource/监控基础设施3.jpg)
![avatar](/resource/监控基础设施4.jpg)
![avatar](/resource/监控基础设施5.jpg)
![avatar](/resource/监控基础设施6.jpg)

## 系统信息监控

主要关注服务器、OS、中间件等基础服务的运行情况.
![avatar](/resource/监控系统信息1.jpg)
![avatar](/resource/监控系统信息2.jpg)
![avatar](/resource/监控系统信息3.png)
![avatar](/resource/监控系统信息4.png)
![avatar](/resource/监控系统信息5.png)

## 业务监控

主要从业务的服务链路和边界上去看端上的用户表达运行是否正常、业务链路是否运行正常、服务边界是否安全会否资损等角度服务业务运行情况.
![avatar](/resource/业务监控.png)

## 用户体验监控

主要从舆情、客诉、性能探测等去观测业务直面用户时的功能是否可用、易用.


# 监控部署

监控部署分为下面四个过程.

## 业务风险点的梳理
没什么可说的.

## 业务系统埋点

对于埋点来说，核心的点是标准化，主要是方便监控的持续性维护和优化，如下为初步整理的监控埋点的一些字段.

* 时间片：业务流水的实时性统计要求需要有时间戳；

* 基础状态片：区分测试、压测、线上流量；

* 结果片：针对业务结果的区分，规范业务服务的活动是否能够完整走到该场景的终态的唯一标识，需要区分success和fail，方便在持续运行中用做绝对值（量）、相对值（率）的监控；

* 错误码片：区分单独的错误码字段，当线上出现错误的时候，可以有效的进行监控的区分，防止正常的逻辑导致误报，错误的逻辑导致漏报;

* 基础逻辑：主要区分上下游关系的逻辑，有助于问题逐层定位；

* 业务表识：主要区分业务流量，单独的一些业务场景和活动出现问题时可以进行区分，防止整体干扰；订单号（线上业务订单的标识）／操作号（后端每一步操作的编码）／业务渠道标（从哪里来的业务流量）／服务标（对应的是哪部分业务）;

* 自定义区间：用于业务自身或者发展的时候一些字段的扩展，例如颗粒度、traceid等；


## 配置和预警校验

1.根据日志配置监控.
2.配置告警项.
3.配置监控大盘.


### 告警项配置

一定程度上来说报警项配置（报警策略）是一个监控项是否能够产生效用的关键；而报警项具体采取什么策略去触发主要和业务容忍度有关，业务容忍度的衡量标准初步可以分为两类：

* 业务变化的趋势：业务变化的趋势是指当业务某种监测指标的变化趋势（下跌、上涨等）超出某个常态的变化空间时需要相关人员介入处理；这类配置相对复杂会在策略配置里重点去讲。

* 业务的固定值：业务的固定值控制又叫做控制线，是指当异常量等值超过某一个容忍允许的固定值（控制线）时，必须有相应的人员介入处理；这类的配置比较简单，完全取决于业务的评估。


#### 告警配置字段
报警策略往往由如图几个字段组成：  
* 指标值的类型  
* 策略值的类型  
* 策略值的取值方式  
* 对比方式  
* 阈值
![avatar](/resource/报警项配置-字段.png)


#### 告警配置策略
监控策略的具体配置就是针对报警策略字段的不断选择和组合的过程.
![avatar](/resource/报警项配置-策略.png)


`1.指标值类型的选择`
指标值的选择相对比较简单，是对于监控的具体指标是选择绝对值，还是相对值的选择：

绝对值：绝对值一般适用于需要对业务上游进行监测的场景和异常量的控制线类的选择；例如：成功量、总量的波动，失败量超出多少阈值的控制线，上升多少幅度等。

相对值：相对值更多的是针对应用服务本身或下游的健康状况的监测；

常态下的配置：常态下的配置由于我们不确定业务是否全链路都有监控，业务上游是否具备监测条件，所以往往出于兜底考虑，在一个报警项中我们会把绝对值和相对值都会配置上。


`2.策略值类型的选择`
策略值的类型选择只和业务的容忍度是为谁负责有关：

相对值（同比、环比）：策略中的相对值表示该业务只对业务曲线的变化趋势负责，而不为具体的值负责；例如：环比下跌、昨日同比下跌、环比上升；

绝对值（具体的值）：绝对值只对控制线类的业务容忍度生效，配置的具体值由业务决策决定；例如：失败量大于30报警；


`3.对比方式的选择`
对比方式的选择只和监测的指标有关，异常量类往往选择大于、等于、上涨超过的波动，正常量监测往往选择小于、下跌超过的波动；

`4.策略值阈值的选择`
阈值的选择是监控策略配置中的重点，也分类2类：

绝对值（量）：绝对值配置相对简单，只与业务的容忍度有关，根据业务决策决定就oK，这里不做赘述。

相对值（同比、环比）：相对值的选择是对于业务变化趋势的判断，是根据选择粒度的值进行业务波动的判断，整个策略配置的分为时间窗口和具体阈值的配置，两者相关性较强，所以在第5点“策略值的窗口时间”选择中一并介绍。

`5.策略值的窗口时间（最近N分钟的N的值）选择`
策略值的窗口时间的选择分为三类：

* 当前时间实时的值：
  * 当前时间实时的值往往针对整体曲线的波动（振幅）在<5%内的曲线适合直接使用当前时间的值进行环比的策略配置；
  * 具体的值的配置参照业务的容忍度，去量化报警的阈值；

* 有周期的策略值的窗口时间和阈值选择：
  * 有周期是指业务曲线的波动在一定的时间窗口内出现明显的业务量的波峰波谷的特征；
  * 24小时内的周期：
    * 针对有周期的策略值的窗口时间：选择近N分钟的N以涵盖波峰或波谷能够摊平波动为主要目的；
    * 针对有周期的策略值的阈值设定：以选择的时间窗口为目的去计算每一个时间窗口的相对波动的稳定值，并和分钟级要求的敏感度去计算阴影面积 进行比例换算计算；
  * 以日、周、月为周期：
    * 针对以日、周、月为周期的策略的时间窗口选择主要用于同比的配置；
    * 在配置的过程中主要根据波峰、波谷在以日、周、月为单位的时间对比中的拟合情况来进行配置：即近N分钟的求和或者求平均的值与昨日、上周、上上周等在同一时间的窗口内波动情况去选择时间窗口和阈值；

* 无周期的脉冲的策略值时间窗口和阈值选择：
  * 无周期的脉冲的时间窗口选择和阈值设定以在一定程度内摊平脉冲带来的曲线波动为目的；
  * 窗口时间的选择依赖需要拉平数据的程度;